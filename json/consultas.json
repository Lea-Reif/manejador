[{"nombreConsulta":"Consultas para la version 3.2","descripcion":"Exacto","fecha":"2019-11-22","consulta":"\nDROP procedure IF EXISTS `Cerrarbash`;\n\nDELIMITER $$\n\nCREATE  PROCEDURE `Cerrarbash`(id_bash int,fecha datetime,ingresos decimal(8,2),\ngastos decimal(8,2),impuestos decimal(8,2),cedula varchar(45), id_sucursal int,_fondos decimal(8,2)\n,_saldar decimal(8,2),_ingresos_impuesto decimal(8,2))\nBEGIN\n\n\/*Insertar el total de facturas por tipo de pagos *\/\ndeclare _tfacturacontado decimal (8,2);\ndeclare _tfacturacredito decimal (8,2);\ndeclare _tfacturachequeTra decimal (8,2);\n\nset _tfacturacontado=(select Get_TotalFactura(id_sucursal,'Al contado')as TotalContado);\nset _tfacturacredito=(select Get_TotalFactura(id_sucursal,'Cr\u00e9dito')as TotalContado);\nset _tfacturachequeTra=(select Get_TotalFactura(id_sucursal,'Cheque o transf')as TotalContado);\n\n\/*Insertando al bash los datos*\/\ninsert into bash values(date_format(fecha,'%Y%m%d'),\nfecha,ingresos,gastos,impuestos,cedula,id_sucursal,null,_fondos,_saldar,\n_ingresos_impuesto,_tfacturacontado,_tfacturacredito,_tfacturachequeTra);\n\nEND$$\n\nDELIMITER ;\n\nDROP TRIGGER IF EXISTS `TG_Facturas_contado`;\n\nDELIMITER $$\nCREATE  trigger TG_Facturas_contado after insert on facturas \n for each row\n begin \n declare Id_sucur int;\n set Id_sucur=(select usuarios.id_sucursal from facturas inner join usuarios on facturas.cedula_usuario=usuarios.cedula where facturas.Id_facturas= new.Id_facturas);\n if(New.Tipo_pago='Al contado')then\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura al contado',new.Id_facturas,Id_sucur);\n end if;\n  if(New.Tipo_pago='Cheque o transf')then\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura transferencia o cheque',new.Id_facturas,Id_sucur);\n end if;\n   if(New.Tipo_pago='Cr\u00e9dito')then\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura a Cr\u00e9dito',new.Id_facturas,Id_sucur);\n end if;\n end\nDELIMITER ;\n\nDROP TRIGGER IF EXISTS `TG_CuentasDiarias_Abonos`;\n\nDELIMITER $$\n\nCREATE  trigger TG_CuentasDiarias_Abonos after insert on abonos \n for each row\n begin \n declare Id_sucur int;\n set Id_sucur=(select usuarios.id_sucursal from abonos inner join usuarios on abonos.Usuario=usuarios.cedula where idAbonos= new.idAbonos);\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.Fecha,new.Abonado,concat('Abono ',new.Tipo_abono),new.idAbonos,Id_sucur);\n end;$$\nDELIMITER ;\n\n\nDROP procedure IF EXISTS `ConfirmarPagos_pagados`;\n\nDELIMITER $$\n\nCREATE PROCEDURE `ConfirmarPagos_pagados`(idcuenta int, \ntipo_pagos varchar(15),cedula varchar(30),_tpago varchar(45),_nocuenta varchar(45))\nBEGIN\ndeclare fecha,cierre datetime;\ndeclare periodos varchar(15);\n\nset fecha=(select Fecha_registro from cuentaspagar where idcuentaspagar=idcuenta);\nset cierre=(select Fecha_cierre from cuentaspagar where idcuentaspagar=idcuenta);\nset periodos=(select Periodo from cuentaspagar where idcuentaspagar=idcuenta);\n\ninsert into pagos(Usuario, Tipo_pago, Id_cuenta,tpago,noCuenta) \nvalue(cedula,tipo_pagos,concat('cp',idcuenta),_tpago,_nocuenta);\n\nif(tipo_pagos='Pago recurrente')then\nif (periodos='Semanal')then\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 7 DAY),Fecha_cierre=date_add(cierre,INTERVAL 7 DAY)  where idcuentaspagar=idcuenta;\nend if;\nif( periodos='Mensual') then\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 1 Month),Fecha_cierre=date_add(cierre,INTERVAL 1 month)  where idcuentaspagar=idcuenta;\nend if;\n if(periodos='Quincenal')then\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 15 Day),Fecha_cierre=date_add(cierre,INTERVAL 15 DAY)  where idcuentaspagar=idcuenta;\nend if;\nif(periodos='Anual')then\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 1 year),Fecha_cierre=date_add(cierre,INTERVAL 1 year) where idcuentaspagar=idcuenta;\nend if;\nelse \nupdate cuentaspagar set Estado_cuenta='Inactiva' where idcuentaspagar=idcuenta;\nend if;\nEND;$$\n\nDELIMITER ;\n\n\nDROP procedure IF EXISTS `ConfirmarPagos`;\n\nDELIMITER $$\n\nCREATE  PROCEDURE `ConfirmarPagos`(idcuenta int, tipo_pagos \nvarchar(15),cedula varchar(30),fecha_p datetime,_tpago varchar(45),_nocuenta varchar(45))\nBEGIN\ndeclare fecha,cierre datetime;\ndeclare periodos varchar(15);\n\nset fecha=(select Fecha_registro from cuentascobros where Id_cobros=idcuenta);\nset cierre=(select Fecha_cierre from cuentascobros where Id_cobros=idcuenta);\nset periodos=(select Periodo from cuentascobros where Id_cobros=idcuenta);\n\ninsert into pagos(Usuario, Tipo_pago, Id_cuenta,Fecha_pago,tpago,noCuenta) \nvalue(cedula,tipo_pagos,concat('cc',idcuenta),fecha_p,_tpago,_nocuenta);\n\nif(tipo_pagos='Pago recurrente')then\nif (periodos='Semanal')then\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 7 DAY),Fecha_cierre=date_add(cierre,INTERVAL 7 DAY)  where Id_cobros=idcuenta;\nend if;\nif( periodos='Mensual') then\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 1 Month),Fecha_cierre=date_add(cierre,INTERVAL 1 month)  where Id_cobros=idcuenta;\nend if;\n if(periodos='Quincenal')then\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 15 Day),Fecha_cierre=date_add(cierre,INTERVAL 15 DAY)  where Id_cobros=idcuenta;\nend if;\nif(periodos='Anual')then\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 1 year),Fecha_cierre=date_add(cierre,INTERVAL 1 year) where Id_cobros=idcuenta;\nend if;\nelse \nupdate cuentascobros set Estado_cuenta='Inactiva' where Id_cobros=idcuenta;\nend if;\nEND$$\n\nDELIMITER ;\n\nDROP TRIGGER IF EXISTS `TG_CuentasDiarias_Pagos`;\n\nDELIMITER $$\n\nCREATE  trigger TG_CuentasDiarias_Pagos after insert on pagos \n for each row\n begin \n declare tipo varchar(45);\n declare _tipo varchar(45);\n declare _proveedor varchar(25);\n declare _cuenta varchar(45);\n declare _conceto text;\n declare cantidad decimal(8,2);\n declare Id_sucur int;\n set Id_sucur=(select usuarios.id_sucursal from pagos inner join usuarios on pagos.Usuario=usuarios.cedula where idPagos= new.idPagos);\n\nif(substring(new.Id_cuenta,1,2)='cc')then\nset cantidad=(select Total_cuenta from cuentascobros where concat('cc',Id_cobros)=new.Id_cuenta);\nset tipo=concat('Cuentas por cobrar ',new.tpago);\n\n INSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)\n value(new.Fecha_pago,cantidad,tipo,new.Id_cuenta,Id_sucur);\n\n\/*Verificando si fue a transferencia bancaria para afectar la tabla transferencia y confirmar el Credito*\/\nif(new.tpago='Transferencia Bancaria')then\ninsert into transferencia values(null,new.noCuenta,now(),'Confirmada','Credito',cantidad,\nconcat('Transferencia de ',tipo),new.Id_cuenta,0);\n\nupdate banking set balance=balance+cantidad where ncuenta=new.noCuenta;\nend if;\nelse\nset cantidad=(select Total_cuenta from cuentaspagar where concat('cp',idcuentaspagar)=new.Id_cuenta);\nset _conceto=(select Concepto from cuentaspagar where concat('cp',idcuentaspagar)=new.Id_cuenta);\nset _proveedor=(select Nombre_proveedor from proveedores join cuentaspagar on proveedores.idProveedores=cuentaspagar.Id_proveedor where concat('cp',idcuentaspagar)=new.Id_cuenta);\nset _tipo=concat('Cuentas por pagar ',new.tpago);\n\n\/*Verificando si fue a transferencia bancaria para afectar la tabla transferencia y confirmar el debito*\/\nif(new.tpago='Transferencia Bancaria')then\ninsert into transferencia values(null,new.noCuenta,now(),'Confirmada','Debito',cantidad,\nconcat('Transferencia de ',_tipo),new.Id_cuenta,0);\n\nupdate banking set balance=balance-cantidad where ncuenta=new.noCuenta;\nend if;\ninsert into gastos_menores(descripcion,suplidor,tipo,hora,monto,estado,idsucursal,idbash) \nvalues(_conceto,_proveedor,_tipo,hour(now()),cantidad,'activo',Id_sucur,DATE_FORMAT(now(),\"%Y%m%d\"));\nend if;\n end;$$\nDELIMITER ;\n\n"},{"nombreConsulta":"Somimo","descripcion":"as","fecha":"2019-11-22","consulta":"holis"},{"nombreConsulta":"Papos","descripcion":"Crear tabla papo","fecha":"2020-04-30","consulta":"create table papo(\nid int)"},{"nombreConsulta":"Test","descripcion":"test","fecha":"2020-05-06","consulta":"DROP procedure IF EXISTS GanadorLoteria;\n\nDELIMITER $$\n\nCREATE PROCEDURE `GanadorLoteria`(fecha_sorteo date, _primera int ,_segunda int,_tercera int, _idloteria int,_idsorteo int)\nBEGIN\n\n\/*Declarando variables necesarias*\/\n        DECLARE v_finished INTEGER DEFAULT 0;\n  DECLARE counter BIGINT DEFAULT 0;\n        DECLARE combinacion_tiquets char(10);\n  DECLARE monto_tiquets decimal(8,2);\n        declare numeros_jugados varchar(15);\n        declare numeros_jugados_primera int;\n        declare numeros_jugados_segunda int;\n        declare numeros_jugados_tercera int;\n        declare estado_jugador char(10);\n        declare premio_jugador float;\n        declare id_jugada int;\n        declare id_loteria_2 int;\n        declare idvendedor int;\n        declare id_tiquets int;\n        \n -- declare cursor for tiquets\n DEClARE cursor_tiquets CURSOR FOR \nselect combinacion,monto,numeros,id,id_loteria2,id_vendedor,id_tiquet from jugadas where estado='PENDIENTE' and id_loteria=_idloteria \nand id_tiquet in(\n select id from tiquets where date_format(fecha,\"%Y-%m-%d\")=fecha_sorteo);\n\n \n -- declare NOT FOUND handler\n DECLARE CONTINUE HANDLER \n        FOR NOT FOUND SET v_finished = 1;\n\n OPEN cursor_tiquets;\n \n get_tiquets: LOOP\n \n FETCH cursor_tiquets INTO combinacion_tiquets,monto_tiquets,numeros_jugados,id_jugada,id_loteria_2,idvendedor,id_tiquets;\n \n IF v_finished = 1 THEN \n LEAVE get_tiquets;\n END IF;\n \/*Inicializando variables por defectos*\/\n set premio_jugador=0;\n set estado_jugador='PERDEDOR';\n \n \/*Cuando vaya por quiniela*\/\n if(combinacion_tiquets='quiniela')then\n \n \/*Si se saco en primera*\/\n if(numeros_jugados=_primera)then\n \n \/*Cuando los pagos de loterias sean por vendedor*\/\n if((select count(*) from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n set premio_jugador=(select primera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n else\n \/*Verificando el pago no sea por vendedor*\/\nSET premio_jugador= premio_jugador+(select primera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n end if;\n\n set estado_jugador='GANADOR';\n end if;\/*Cierre del tiquet en primera*\/\n \n  \/*Si se saco en segunda*\/\n if(numeros_jugados=_segunda)then\n \n  \/*Cuando los pagos de loterias sean por vendedor*\/\n  if((select count(*) from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n  set premio_jugador=premio_jugador+(select segunda*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador=premio_jugador+ (select  segunda*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n  \n  \n   set estado_jugador='GANADOR';\n   end if;\/**Cierre del tiquet en primera*\/\n   \n    \/*Si se saco en tercera*\/\n if(numeros_jugados=_tercera)then\n \n  \/*Cuando los pagos de loterias sean por vendedor*\/\n if((select count(*) from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n  set premio_jugador=premio_jugador+(select tercera*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  \n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador=premio_jugador+ (select tercera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n   set estado_jugador='GANADOR';\n  end if;\/*Cierre del if del tique de tercera*\/\n  \n  \/*Cuando vaya por pale*\/\n elseif(combinacion_tiquets='pale')then\n set numeros_jugados_primera = substr(numeros_jugados,1,2);\n set numeros_jugados_segunda = substr(numeros_jugados,4,2);\n  \n  \/*Si el pale fue en primera y segunda*\/\nif((concat(numeros_jugados_primera,'-',n\n\nCristian Herrera Alc\u00e1ntara, [11.05.20 23:23]\numeros_jugados_segunda)=(concat(_primera,'-',_segunda) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_primera,'-',_segunda) ))||\n (concat(numeros_jugados_primera,'-',numeros_jugados_segunda)=(concat(_segunda,'-',_primera) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_segunda,'-',_primera) )) )then\n \n \/*Cuando los pagos de loterias sean por vendedor*\/\n if((select count(*) from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n set premio_jugador=premio_jugador+(select primera*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  \n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador= premio_jugador+(select primera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n  \n   set estado_jugador='GANADOR';\n   \n   \/*Si el pale fue en primera y tercera*\/\n   elseif((concat(numeros_jugados_primera,'-',numeros_jugados_segunda)=(concat(_primera,'-',_tercera) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_primera,'-',_tercera) ))||\n (concat(numeros_jugados_primera,'-',numeros_jugados_segunda)=(concat(_tercera,'-',_primera) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_tercera,'-',_primera) )) )then\n \n \/*Cuando los pagos de loterias sean por vendedor*\/\n if((select count(*) from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n set premio_jugador=premio_jugador+(select primera*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  \n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador= premio_jugador+ (select primera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n   set estado_jugador='GANADOR';\n\n   \/*Si el pale fue en segunda y tercera*\/\n      \/*Si el pale fue en primera y tercera*\/\n   elseif((concat(numeros_jugados_primera,'-',numeros_jugados_segunda)=(concat(_segunda,'-',_tercera) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_segunda,'-',_tercera) ))||\n (concat(numeros_jugados_primera,'-',numeros_jugados_segunda)=(concat(_tercera,'-',_segunda) )) ||\n (concat(numeros_jugados_segunda,'-',numeros_jugados_primera)=(concat(_tercera,'-',_segunda) )) )then\n \n \/*Cuando los pagos de loterias sean por vendedor*\/\n if((select count(*) from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n set premio_jugador=premio_jugador+(select segunda*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  \n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador= premio_jugador+(select segunda*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n   set estado_jugador='GANADOR';\nend if;\/*Cierre del if de pale*\/\n\n  \/*Cuando vaya por tripleta*\/\n elseif(combinacion_tiquets='tripleta')then\n set numeros_jugados_primera = substr(numeros_jugados,1,2);\n set numeros_jugados_segunda = substr(numeros_jugados,4,2);\n set numeros_jugados_tercera = substr(numeros_jugados,7,2);\n \n \/*Cuando es tripleta entera*\/\n if((numeros_jugados_primera=_primera|| numeros_jugados_primera=_segunda || numeros_jugados_primera=_tercera) &&\n (numeros_jugados_segunda=_primera|| numeros_jugados_segunda=_segunda || numeros_jugados_segunda=_tercera) &&\n (numeros_jugados_tercera=_primera|| numeros_jugados_tercera=_segunda || numeros_jugados_tercera=_tercera))then\n \n  \/*Cuando los pagos de loterias sean por vendedor*\/\n  if((select count(*)from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n set premio_jugador=premio_jugador+(select primera*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n  \n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador= premio_jugador+(select primera*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n   set estado_jugador='GANADOR';\n   \n    \/*Cuando pegas dos numeros de la tripleta*\/\n   elseif(((numeros_jugados_primera=_primera||numeros_jugados_segunda=_primera||numeros_jugados_tercera=_primera)&&\n   ((numeros_jugados_primera=_segunda||numeros_jugados_segunda=_segunda||numeros_jugados_tercera=_segunda)||\n   (numeros_jugados_primera=_tercera||numeros_jugados_segunda=_tercera||numeros_jugados_tercera=_tercera))) ||\n   (numeros_jugados_primera=_segunda||numeros_jugados_segunda=_segunda||numeros_jugados_tercera=_segunda)&& \n   (numeros_jugados_primera=_tercera||numeros_jugados_segunda=_tercera||numeros_jugados_tercera=_tercera))then\n   \n     \/*Cuando los pagos de loterias sean por vendedor*\/\n  if((select count(*)from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor)<>0)then\n   set premio_jugador=premio_jugador+(select segunda*monto_tiquets from loteria_pagos \n  where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=idvendedor);\n\n  else\n  \/*Verificando el pago por vendedor o no*\/\nSET premio_jugador=premio_jugador+(select segunda*monto_tiquets from loteria_pagos\n where combinacion=combinacion_tiquets and id_loteria=_idloteria and id_vendedor=0);\n  end if;\n   set estado_jugador='GANADOR';\n   end if;\/*Cierre del if de la tripleta*\/\nend if; \/*Cierre del if de la combinacion*\/\nupdate jugadas set estado=estado_jugador,premios=premios+premio_jugador\nwhere id=id_jugada;\nupdate tiquets set idsorteo=_idsorteo where id=id_tiquets;\n END LOOP get_tiquets;\n \n CLOSE cursor_tiquets;\nEND$$\n\nDELIMITER ;"}]